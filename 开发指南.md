# 后端开发指南

## 项目结构

```
naive-admin-backend/
├── src/
│   ├── auth/              # 认证模块
│   ├── user/              # 用户模块
│   ├── role/              # 角色模块
│   ├── menu/              # 菜单模块
│   ├── table/             # 表格模块
│   ├── app.module.ts       # 主模块
│   └── main.ts           # 入口文件
├── data/                 # 数据库文件（不提交到 git）
└── uploads/              # 上传文件（不提交到 git）
```

## 开发规范

### 1. API 响应格式

所有 API 接口必须返回统一的响应格式：

```typescript
// 成功响应
{
  code: 200,
  result: any,           // 实际数据
  message?: string        // 可选的成功消息
}

// 列表响应
{
  code: 200,
  result: {
    page: number,        // 当前页码
    pageSize: number,    // 每页数量
    pageCount: number,    // 总页数
    itemCount: number,    // 总记录数
    list: any[]         // 数据列表
  }
}
```

### 2. 错误处理

所有 Controller 方法必须添加 try-catch 错误处理：

```typescript
@Post()
async create(@Body() data: any) {
  try {
    const result = await this.service.create(data);
    return {
      code: 200,
      result,
      message: '创建成功',
    };
  } catch (error) {
    // 处理唯一约束错误
    if (error instanceof QueryFailedError && 
        (error as any).message.includes('UNIQUE constraint failed')) {
      throw new HttpException('名称已存在', HttpStatus.BAD_REQUEST);
    }
    throw error;
  }
}
```

### 3. 数据库实体设计

- 唯一字段必须添加 `unique: true`
- 关联字段使用 `@ManyToMany` 和 `@JoinTable`
- 时间字段使用 `@CreateDateColumn` 和 `@UpdateDateColumn`
- 枚举类型字段使用 `@Column({ default: 'default_value' })`

### 4. Git 配置

以下文件和文件夹不应提交到 git：

```gitignore
# Database files
data/
*.sqlite
*.sqlite3

# Uploads
uploads/

# Build files
/dist

# Environment files
.env.local
.env.*.local
```

## 常见问题

### 问题 1：前端调用 API 后表格不刷新

**原因**：创建/编辑成功后没有触发表格刷新

**解决方案**：
1. 在子组件（Modal）中添加 `emit('success')`
2. 在父组件中监听 `@success="reloadTable"`

```typescript
// 子组件
const emit = defineEmits(['success']);
async function okModal() {
  await createRole(data);
  emit('success');
}

// 父组件
<CreateModal @success="reloadTable" />
```

### 问题 2：错误信息不友好

**原因**：只显示"创建失败"，没有显示具体错误

**解决方案**：从错误对象中提取实际错误信息

```typescript
catch (error: any) {
  const errorMsg = error?.response?.data?.message || 
                 error?.message || 
                 '创建失败';
  message.error(errorMsg);
}
```

### 问题 3：async/await 语法错误

**原因**：函数中使用了 `await` 但没有声明为 `async`

**解决方案**：添加 `async` 关键字

```typescript
// 错误
function handleDelete() {
  await deleteRole(id);
}

// 正确
async function handleDelete() {
  await deleteRole(id);
}
```

### 问题 4：数据结构不匹配

**原因**：
- Alova 返回的是 `{ code, result, message }`
- BasicTable 期望直接返回数据对象

**解决方案**：
1. 修改 `componentSetting.ts` 中的字段配置
2. 在 `loadDataTable` 中返回 `response.result`

```typescript
// componentSetting.ts
apiSetting: {
  listField: 'list',        // 后端返回的字段名
  totalField: 'pageCount',
  countField: 'itemCount',
}

// loadDataTable
const loadDataTable = async (res: any) => {
  const response = await getRoleList(params);
  return response.result;  // 返回 result 对象，不是完整响应
};
```

### 问题 5：默认搜索参数导致数据过滤

**原因**：`params` 有默认值，导致查询时过滤了数据

**解决方案**：将默认值设为空字符串

```typescript
// 错误
const params = reactive({
  name: 'NaiveAdmin',  // 会过滤掉不包含 'NaiveAdmin' 的数据
});

// 正确
const params = reactive({
  name: '',  // 不过滤任何数据
});
```

## 开发流程

### 1. 创建新模块

```bash
# 1. 创建模块文件夹
mkdir src/moduleName

# 2. 创建实体
touch src/moduleName/moduleName.entity.ts

# 3. 创建服务
touch src/moduleName/moduleName.service.ts

# 4. 创建控制器
touch src/moduleName/moduleName.controller.ts

# 5. 创建模块
touch src/moduleName/moduleName.module.ts
```

### 2. 注册模块

在 `app.module.ts` 中导入并注册新模块：

```typescript
import { ModuleNameModule } from './moduleName/moduleName.module';

@Module({
  imports: [
    ModuleNameModule,
    // ...
  ],
})
export class AppModule {}
```

### 3. 测试接口

使用 Postman 或其他工具测试接口：

```bash
# 列表
GET http://localhost:3001/api/moduleName/list?page=1&pageSize=10

# 详情
GET http://localhost:3001/api/moduleName/:id

# 创建
POST http://localhost:3001/api/moduleName
Content-Type: application/json

# 更新
PUT http://localhost:3001/api/moduleName/:id
Content-Type: application/json

# 删除
DELETE http://localhost:3001/api/moduleName/:id
```

## 前后端对接注意事项

### 1. 数据字段映射

确保前后端字段名一致：

| 后端字段 | 前端字段 | 说明 |
|---------|----------|------|
| id | id | 主键 |
| name | name | 名称 |
| explain | explain | 说明 |
| isDefault | isDefault | 是否默认 |
| menuKeys | menu_keys | 菜单权限（注意驼峰和下划线） |

### 2. 分页参数

后端接收：
- `page`: 当前页码
- `pageSize`: 每页数量
- `name`: 搜索关键词

后端返回：
- `page`: 当前页码
- `pageSize`: 每页数量
- `pageCount`: 总页数
- `itemCount`: 总记录数
- `list`: 数据列表

### 3. 错误码

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

## 数据库操作

### 1. 查询

```typescript
// 查询所有
const list = await this.repository.find();

// 条件查询
const item = await this.repository.findOne({ where: { id } });

// 分页查询
const [list, total] = await this.repository
  .createQueryBuilder('alias')
  .skip((page - 1) * pageSize)
  .take(pageSize)
  .getManyAndCount();

// 关联查询
const item = await this.repository.findOne({
  where: { id },
  relations: ['relatedEntity'],
});
```

### 2. 创建

```typescript
const entity = this.repository.create(data);
await this.repository.save(entity);
```

### 3. 更新

```typescript
await this.repository.update(id, data);
return await this.repository.findOne({ where: { id } });
```

### 4. 删除

```typescript
await this.repository.delete(id);
```

## 安全注意事项

1. **密码加密**：使用 bcrypt 加密存储密码
2. **JWT 认证**：使用 JWT 进行身份验证
3. **CORS 配置**：允许前端域名访问
4. **输入验证**：使用 class-validator 验证请求数据
5. **SQL 注入防护**：使用 TypeORM 的参数化查询

## 性能优化

1. **索引优化**：为常用查询字段添加索引
2. **关联查询**：使用 `relations` 避免多次查询
3. **分页查询**：大数据量必须分页
4. **缓存策略**：对不常变的数据添加缓存

## 部署注意事项

1. **环境变量**：生产环境使用 `.env.production`
2. **数据库**：生产环境使用 MySQL，开发环境使用 SQLite
3. **日志级别**：生产环境使用 `error` 级别
4. **端口配置**：使用环境变量配置端口
5. **静态文件**：配置 Nginx 处理静态文件

## 总结

这次开发中遇到的主要问题：

1. ✅ 前端 API 接口不完整 - 需要补充 CRUD 接口
2. ✅ 表单提交逻辑缺失 - 需要调用实际 API
3. ✅ async/await 语法错误 - 需要添加 async 关键字
4. ✅ 表格刷新机制 - 需要使用 emit 通知父组件
5. ✅ 错误处理不友好 - 需要显示具体错误信息
6. ✅ 数据结构不匹配 - 需要正确处理 Alova 响应
7. ✅ 默认搜索参数 - 需要设置为空字符串
8. ✅ Git 配置问题 - 需要忽略 dist、data、uploads 文件夹

后续开发时，请务必遵循本指南，避免重复踩坑！
